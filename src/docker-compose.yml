version: '3.4'
services:
    elasticsearch:
        image: docker.elastic.co/elasticsearch/elasticsearch:8.10.4
        container_name: elasticsearch
        ports:
            - 5001:9200
        environment:
            - discovery.type=single-node
            - cluster.name=elasticsearch
            - node.name=elasticsearch
            - discovery.seed_hosts=elasticsearch
            - xpack.security.enabled=false

    fluent-bit:
        image: fluent/fluent-bit
        container_name: fluent-bit
        volumes:
            - ./fluent-bit/conf/fluent-bit.conf:/fluent-bit/etc/fluent-bit.conf
            - ./fluent-bit/conf/parsers.conf:/fluent-bit/etc/parsers.conf
        environment:
            - FLB_ES_HOST=elasticsearch
            - FLB_ES_PORT=9200
        ports:
            - 24224:24224
            - 24224:24224/udp
        depends_on:
            - elasticsearch

    kibana:
        image: docker.elastic.co/kibana/kibana:8.10.4
        container_name: kibana
        ports:
            - 5003:5601
        environment:
            - ELASTICSEARCH_URL=http://elasticsearch:9200
            - ELASTICSEARCH_HOSTS=http://elasticsearch:9200
        depends_on:
            - fluent-bit
            - elasticsearch
        logging:
            driver: fluentd
            options:
                tag: application.kibana
    
    postgres:
        build: ./postgres
        image: postgres:15.1
        container_name: postgres
        restart: always
        ports:
            - 5004:5432
        environment:
            - POSTGRES_PASSWORD=appadmin!@#$%
            - POSTGRES_USER=appadmin
            - POSTGRES_DB=application
        volumes:
            - postgres_data:/var/lib/postgresql/data
        command: postgres -c config_file=/etc/conf/postgresql.conf
        depends_on:
            - fluent-bit
        logging:
            driver: fluentd
            options:
                tag: application.postgres
        
    keycloak:
        image: quay.io/keycloak/keycloak:22.0.5
        container_name: keycloak
        ports:
            - 5005:8080
        environment:
            - KEYCLOAK_ADMIN=appadmin
            - KEYCLOAK_ADMIN_PASSWORD=appadmin!@#$%
            - KC_DB=postgres
            - KC_DB_URL_HOST=postgres
            - KC_DB_URL_DATABASE=application
            - KC_DB_USERNAME=appadmin
            - KC_DB_SCHEMA=auth
            - KC_DB_PASSWORD=appadmin!@#$%
            - KC_HEALTH_ENABLED=true
            - KC_METRICS_ENABLED=true
        command: start-dev --log=console  
        depends_on:
            - postgres
            - fluent-bit
        logging:
            driver: fluentd
            options:
                tag: application.keycloak

    catalog.api:
        build:
            context: .
            dockerfile: ./catalog/app/Catalog.Api/Dockerfile
        image: catalog.api:1.1
        container_name: catalog.api
        ports:
            - 5006:5006
            - 5007:5007
        depends_on:
            - postgres
            - fluent-bit
        logging:
            driver: fluentd
            options:
                tag: application.catalog

    file.api:
        build:
            context: .
            dockerfile: ./file/app/File.Api/Dockerfile
        image: file.api:1.1
        container_name: file.api
        ports:
            - 5008:5008
            - 5009:5009
        depends_on:
            - fluent-bit
        volumes:
            - file_data:/var/lib/files/data
        logging:
            driver: fluentd
            options:
                tag: application.file

    kong.migration:
        image: kong/kong-gateway:3.4.1.1
        container_name: kong.migration
        environment:
            - KONG_DATABASE=postgres
            - KONG_PG_DATABASE=application
            - KONG_PG_SCHEMA=kong
            - KONG_PG_HOST=postgres
            - KONG_PG_USER=appadmin
            - KONG_PG_PASSWORD=appadmin!@#$%
            - KONG_PROXY_ACCESS_LOG=/dev/stdout
            - KONG_ADMIN_ACCESS_LOG=/dev/stdout
            - KONG_PROXY_ERROR_LOG=/dev/stderr
            - KONG_ADMIN_ERROR_LOG=/dev/stderr
        command: sh -c "kong migrations bootstrap && kong migrations up"
        depends_on:
            - fluent-bit
            - postgres
        logging:
            driver: fluentd
            options:
                tag: application.kong-migration

    kong.gateway:
        image: kong/kong-gateway:3.4.1.1
        container_name: kong.gateway
        ports:
            - 8000:8000
            - 8001:8001
            - 8002:8002
        environment:
            - KONG_DATABASE=postgres
            - KONG_PG_DATABASE=application
            - KONG_PG_SCHEMA=kong
            - KONG_PG_HOST=postgres
            - KONG_PG_USER=appadmin
            - KONG_PG_PASSWORD=appadmin!@#$%
            - KONG_PROXY_ACCESS_LOG=/dev/stdout
            - KONG_ADMIN_ACCESS_LOG=/dev/stdout
            - KONG_PROXY_ERROR_LOG=/dev/stderr
            - KONG_ADMIN_ERROR_LOG=/dev/stderr
            - KONG_ADMIN_LISTEN=0.0.0.0:8001
            - KONG_ADMIN_GUI_URL=http://localhost:8002
        depends_on:
            - kong.migration
        logging:
            driver: fluentd
            options:
                tag: application.kong
            
volumes:
  postgres_data:
      driver: local
  file_data:
      driver: local